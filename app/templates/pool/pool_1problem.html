{% extends "pool/pool_header.html" %}
{% block pool_body %}

<script>
    function RenderSolution() {
        var input = prevent_injection(document.getElementById("solution_textarea").value);
        document.getElementById("solution_latex_output").innerHTML = render_multiline_text(input);
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, "solution_latex_output"]);
    }
</script>

{% if current_user.get_pool_relation(current_pool.id).role.isOwner() %}
<div class="flex justify-between">
    {% if current_problem.is_public %}
    <div class="flex flex-row items-center mt-4">
        <h3 class="text-red-400 font-bold text-xl">Вы не можете редактировать задачу, если она опубликована</h3>
        <span class="text-slate-500 font-bold mx-4">|</span>
        <form action="/pool/{{ current_pool.hashed_id }}/problems" method="post">
            <input type="hidden" name="back_to_pool" value="{{ current_pool.hashed_id }}">
            <input type="hidden" name="problem_hashed_id" value="{{ current_problem.hashed_id }}">
            <input type="submit" value="Вернуть на доработку?"
                class="hover:font-bold hover:cursor-pointer hover:text-blue-600">
        </form>
    </div>
    {% endif %}
    {% if not current_problem.is_public %}
    <form action="/archive/publish/{{current_problem.hashed_id}}" method="post" class="w-full flex flex-row justify-end">
        <input type="submit"
            class="hover:cursor-pointer px-12 py-2 rounded-xl text-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 active:bg-blue-700"
            value="Опубликовать в архив">
    </form>
    {% elif current_problem.is_public and not current_problem.moderated %}
    <span
        class="hover:cursor-pointer px-12 py-2 rounded-xl text-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 active:bg-blue-700">
        На модерации
    </span>
    {% else %}
    <span
        class="hover:cursor-pointer px-12 py-2 rounded-xl text-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 active:bg-blue-700">
        В архиве
    </span>
    {% endif %}
</div>
{% endif %}
<div class="flex flex-col">
    <form autocomplete="off" action="/pool/{{ current_pool.hashed_id }}/problem/{{ current_problem.hashed_id }}" method="post"
        class="w-full mt-2 px-4" enctype="multipart/form-data">
        <input type="hidden" name="save_problem" value="239">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
        {% if category == "danger" %}
        <div
            class="w-1/2 text-stone-800 text-semibold rounded p-6 text-lg text-center bg-red-400 border-2 border-solid border-red-600">
            {{ message }}</div>
        {% elif category == "warning" %}
        <div
            class="w-1/2 text-stone-800 text-semibold rounded p-6 text-lg text-center bg-yellow-400 border-2 border-solid border-yellow-600">
            {{ message }}</div>
        {% elif category == "success" %}
        <div
            class="w-1/2 text-stone-800 text-semibold rounded p-6 text-lg text-center bg-green-400 border-2 border-solid border-green-600">
            {{ message }}</div>
        {% endif %}
        {% endfor %}
        {% endwith %}

        <div class="flex flex-row items-center mt-4">
            <h1 class="mr-4 text-2xl font-bold">{{ current_problem.name }}</h1>
            <input type="submit" value="Сохранить"
                class="hover:cursor-pointer px-8 py-2 rounded-xl text-lg text-white font-semibold bg-green-500 hover:bg-green-600 active:bg-green-700">
        </div>
        
        <h2 class="text-slate-500 font-bold text-xl ml-2 mt-4 mb-2">Название:</h2>
        <div class="flex w-full">
            <textarea rows="1" cols="50" name="name" class="text-lg w-full p-4 border-slate-200 border-2 rounded-lg" {%
                if current_problem.is_public %} readonly {% endif %}>{{ current_problem.name }}</textarea>
        </div>

        <h2 class="text-slate-500 font-bold text-xl ml-2 mt-4 mb-2">Условие:</h2>
        <div class="flex w-full">
            <textarea id="statement_textarea" rows="10" cols="50" name="statement" {% if current_problem.is_public %}
                readonly {% endif %} class="w-1/2 p-4 border-slate-200 border-2 rounded-lg">{{ current_problem.statement }}</textarea>
        </div>

        <script>
            makeLaTeXArea("statement_textarea");
        </script>

        <div class="text-slate-500 font-bold text-xl ml-2 mt-4 mb-2 flex flex-row justify-between items-center">
            <span>Решение:</span>
            <span class="flex flex-row justify-center items-center">
                Показывать пользователям решение
                <span class="text-slate-500 font-bold mx-4">|</span>
                {% if current_problem.show_solution %}
                <label
                    class="flex justify-center items-center hover:cursor-pointer p-2 border-slate-200 border bg-green-200 rounded">
                    <input type="checkbox" name="show_solution" class="w-0 h-0" id="show_solution_checkbox" checked>
                    <img src="/static/images/pwd_show.png" class="h-8">
                </label>
                {% else %}
                <label
                    class="flex justify-center items-center hover:cursor-pointer p-2 border-slate-200 border bg-red-200 rounded">
                    <input type="checkbox" name="show_solution" class="w-0 h-0" id="show_solution_checkbox">
                    <img src="/static/images/pwd_hide.png" class="h-8">
                </label>
                {% endif %}
            </span>
        </div>
        <div class="flex w-full">
            <textarea id="solution_textarea" rows="10" cols="50" name="solution" {% if current_problem.is_public %}
                readonly {% endif %} class="w-1/2 p-4 border-slate-200 border-2 rounded-lg">{{ current_problem.solution }}</textarea>
        </div>

        <script>
            makeLaTeXArea("solution_textarea");
        </script>

        <h2 class="text-slate-500 font-bold text-xl ml-2 mt-4 mb-2">Вложения:</h2>
        <div class="flex border-2 border-slate-200 p-8 rounded-xl bg-white">
            <div class="border-r-2 border-slate-300 grow">
                <div class="flex flex-col gap-y-4 mr-4">
                    <ul class="flex flex-col gap-y-2" id="files-list">
                        {% for attachment in current_problem.get_attachments() %}
                        <li class="flex w-full gap-x-2">
                            <input type="text" name="attachment_name {{ attachment.db_filename }}" id="attachment-name-{{ attachment.db_filename }}"
                                value="{{ attachment.short_name }}" placeholder="Как назвать картинку?" {% if current_problem.is_public %} readonly {% endif %}
                                class="input-attachment-name text-lg text-slate-800 border-slate-200 border rounded-lg px-2 grow">
                            {% if not current_problem.is_public %}
                                <button onclick="DeleteAttachment(this)"
                                class="text-lg border-slate-200 border bg-slate-50 hover:bg-slate-100 hover:cursor-pointer px-4 py-2 rounded-lg text-red-400">Удалить</button>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    <div class="border-2 border-blue-500 border-dashed px-8 py-4 rounded-xl flex justify-center {% if current_problem.is_public %} hidden {% endif %}">
                        <label class="label text-lg">
                            <input type="file" class="file-input w-0 h-0" name="attachments" accept="image/*" multiple {% if current_problem.is_public %} readonly {% endif %}>
                            {% if not current_problem.is_public %}
                            <span class="browse-files-text text-blue-500 font-semibold cursor-pointer inline-block"
                                onclick="ResetFileInput()">загрузить файлы</span>
                            {% endif %}
                        </label>
                    </div>
                </div>
            </div>

            <div class="w-2/3 ml-4">
                <img id="display-attachment" class="hidden border-2 border-sky-400 padding-8 rounded-xl">
            </div>
        </div>
        <div class="h-px w-full bg-neutral-300 my-2"></div>
        <details>
            <summary class="text-slate-500 font-bold">Теги:</summary>
            <div class="flex gap-x-8 items-start">
                <ul class="w-full" id="tas_list">
                    {% for tag in current_problem.get_tags() %}
                    <li class="flex">
                        <input type="hidden" name="tag {{ tag.name }}" value="{{ tag.name }}">
                        <span class="text-slate-500 font-bold mr-4">#</span>
                        <div class="w-2/3"><span>{{ tag.name }}</span></div>
                        <span class="text-slate-500 font-bold mx-4">|</span>
                        <button type="button" class="hover:font-bold hover:cursor-pointer hover:text-red-600"
                            onclick="DeleteTag(this)">Удалить тег</button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="flex w-full">
                    <span class="text-slate-500 font-bold mr-4">#</span>
                    <div class="w-2/3 relative inline-block">
                        <input id="addtag" type="text" placeholder="Введите тег" name="tag_name"
                            class="w-full border-slate-400 border-2 rounded px-2">
                    </div>
                    <span class="text-slate-700 font-bold mx-4">|</span>
                    <button type="button" class="hover:font-bold hover:cursor-pointer hover:text-green-600"
                        onclick="AddTag()">Добавить тег</button>
                </div>
            </div>
        </details>
    </form>




</div>

<script>
    var inputs = document.querySelectorAll(".input-attachment-name");
    var display = document.querySelector("#display-attachment");
    display.onerror = () => {
        this.classList.add("hidden");
        this.onerror = null;
    }
    {% for attachment in current_problem.attachments %}
    inputs[{{ loop.index - 1 }}].addEventListener("focus", function (event) {
        inputs.forEach((input) => {
            input.classList.remove("border-black", "bg-slate-100");
        })
        this.classList.add("border-black", "bg-slate-100");
        display.src = "{{ url_for('pool.show_problem_attachment', pool_hashed_id=current_pool.hashed_id, problem_hashed_id=current_problem.hashed_id, filename=attachment.db_filename) }}";
        display.classList.remove("hidden");
        display.classList.add("block");
    })
    {% endfor %}
</script>

<script>
    let fileInput = document.querySelector(".file-input");
    let filesList = document.getElementById("files-list");
    fileInput.addEventListener("change", function (event) {
        for (let i = 0; i < this.files.length; i++) {

            const Data = new FormData();
            Data.append("file", this.files[i]);
            Data.append("name", this.files[i].name);
            Data.append("type", this.files[i].type);
            Data.append("size", this.files[i].size);

            fetch(`${ window.location.href }/upload_file`, {
                method: "POST",
                body: Data
            }).then((response) => {
                if (response.status == 200) {
                    return response.text();
                } else {
                    throw new Error("Bad file");
                }
            }).then(result => {
                    if (result[0] == "O" && result[1] == "K") {
                        var attachment_db_filename = result.slice(3);

                        filesList.innerHTML += `
                        <li class="flex w-full gap-x-2">
                            <input type="text" name="attachment_name ${ attachment_db_filename }" id="attachment-name-${ attachment_db_filename }"
                            value="Рисунок" placeholder="Как назвать картинку?"
                            class="input-attachment-name text-lg text-slate-800 border-slate-200 border rounded-lg px-2 grow">
                            <button onclick="DeleteAttachment(this)"
                            class="text-lg border-slate-200 border bg-slate-50 hover:bg-slate-100 hover:cursor-pointer px-4 py-2 rounded-lg text-red-400">Удалить</button>
                        </li>
                        `
                    }
                }
            );
        }
    })
</script>

<script>
    function DeleteAttachment(element) {
        element.parentElement.remove();
    }
    function ResetFileInput() {
        let fileInput = document.querySelector(".file-input");
        fileInput.value = "";
        fileInput.type = "";
        fileInput.type = "file";
    }
</script>


<script>
    let show_solution_checkbox = document.getElementById("show_solution_checkbox");
    show_solution_checkbox.addEventListener("change", function (event) {
        if (this.checked) {
            this.parentNode.querySelector('img').src = "/static/images/pwd_show.png";
            this.parentNode.classList.remove("bg-red-200");
            this.parentNode.classList.add("bg-green-200");
        }
        else {
            this.parentNode.querySelector('img').src = "/static/images/pwd_hide.png";
            this.parentNode.classList.remove("bg-green-200");
            this.parentNode.classList.add("bg-red-200");
        }
    })
</script>

<script>
    function AddTag() {

        let tag = document.getElementById("addtag");
        let tag_name = prevent_injection(tag.value);
        tag.value = "";

        let tags_list = document.getElementById("tas_list");

        tags_list.appendChild(document.createElement("li"));
        let child = tags_list.lastChild;

        child.classList = "flex";


        child.innerHTML = `<input type="hidden" name="tag ${tag_name}" value="${tag_name}">
        <span class="text-slate-500 font-bold mr-4">#</span>
        <div class="w-2/3"><span>${tag_name}</span></div>
        <span class="text-slate-500 font-bold mx-4">|</span>
        <button type="button" class="hover:font-bold hover:cursor-pointer hover:text-red-600" onclick="DeleteTag(this)">Удалить тег</button>`

    }
</script>

<script>
    function DeleteTag(element) {
        element.parentElement.remove();
    }
</script>

<script>
    function autocomplete(inp, arr) {
        /*the autocomplete function takes two arguments,
        the text field element and an array of possible autocompleted values:*/
        var currentFocus;
        /*execute a function when someone writes in the text field:*/
        inp.addEventListener("input", function (e) {
            var a, b, i, val = this.value;
            /*close any already open lists of autocompleted values*/
            closeAllLists();
            /* comment if you want to process empty input */
            if (!val) { return false; }
            currentFocus = -1;
            /*create a DIV element that will contain the items (values):*/
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.classList.add("absolute", "z-50", "top-full", "inset-x-0", "overflow-y-auto", "h-60", "autocomplete-items");
            /*append the DIV element as a child of the autocomplete container:*/
            this.parentNode.appendChild(a);
            /*for each item in the array...*/
            for (i = 0; i < arr.length; i++) {
                /*check if the item starts with the same letters as the text field value:*/
                if (arr[i].toUpperCase().includes(val.toUpperCase())) {
                    /*create a DIV element for each matching element:*/
                    b = document.createElement("DIV");
                    b.classList.add("p-4", "cursor-pointer", "bg-white", "border-b-2", "border-gray-200", "hover:bg-gray-100");
                    var idx = arr[i].toUpperCase().indexOf(val.toUpperCase());
                    /*make the matching letters bold:*/
                    b.innerHTML += arr[i].substr(0, idx);
                    b.innerHTML += "<strong>" + arr[i].substr(idx, val.length) + "</strong>";
                    b.innerHTML += arr[i].substr(idx + val.length);

                    /*insert a input field that will hold the current array item's value:*/
                    b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                    /*execute a function when someone clicks on the item value (DIV element):*/
                    b.addEventListener("click", function (e) {
                        /*insert the value for the autocomplete text field:*/
                        inp.value = this.getElementsByTagName("input")[0].value;
                        /*close the list of autocompleted values,
                        (or any other open lists of autocompleted values:*/
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            }
        });
        /*execute a function presses a key on the keyboard:*/
        inp.addEventListener("keydown", function (e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                /*If the arrow DOWN key is pressed,
                increase the currentFocus variable:*/
                currentFocus++;
                /*and and make the current item more visible:*/
                addActive(x);
            } else if (e.keyCode == 38) { //up
                /*If the arrow UP key is pressed,
                decrease the currentFocus variable:*/
                currentFocus--;
                /*and and make the current item more visible:*/
                addActive(x);
            } else if (e.keyCode == 13) {
                /*If the ENTER key is pressed, prevent the form from being submitted,*/
                e.preventDefault();
                if (currentFocus > -1) {
                    /*and simulate a click on the "active" item:*/
                    if (x) x[currentFocus].click();
                }
            }
        });
        function addActive(x) {
            /*a function to classify an item as "active":*/
            if (!x) return false;
            /*start by removing the "active" class on all items:*/
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            /*add class "autocomplete-active":*/
            x[currentFocus].classList.add("!bg-sky-400", "autocomplete-active");
        }
        function removeActive(x) {
            /*a function to remove the "active" class from all autocomplete items:*/
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("!bg-sky-400", "autocomplete-active");
            }
        }
        function closeAllLists(elmnt) {
            /*close all autocomplete lists in the document,
            except the one passed as an argument:*/
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        /*execute a function when someone clicks in the document:*/
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    /*An array containing all the country names in the world:*/
    var tags = [];
    /* append all tags to the tags array:*/
    {% for tag in all_tags %}
    tags.push("{{ tag.name }}");
    {% endfor %}

    /*initiate the autocomplete function on the "myInput" element, and pass along the countries array as possible autocomplete values:*/
    autocomplete(document.getElementById("addtag"), tags);
</script>

{% endblock %}